<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Watchlist - Stock Analysis Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <style>
        .liquid-glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .liquid-glass-dark {
            background: #141414;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        .theme-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .stock-card {
            transition: all 0.3s ease;
        }
        
        .stock-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* Auto-suggestion styles */
        .suggestions-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 50;
            max-height: 300px;
            overflow-y: auto;
        }

        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s;
        }

        .suggestion-item:hover {
            background-color: #f9fafb;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item.selected {
            background-color: #3b82f6;
            color: white;
        }

        .search-input-container {
            position: relative;
        }
        
        /* Sparkline chart styles */
        .sparkline-container {
            position: relative;
            width: 80px;
            height: 32px;
        }
        
        .sparkline-line {
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .sparkline-positive {
            stroke: #10b981;
        }
        
        .sparkline-negative {
            stroke: #ef4444;
        }
        
        .sparkline-neutral {
            stroke: #6b7280;
        }
        
        /* List view hover effects */
        .list-item-hover {
            transition: all 0.2s ease-in-out;
        }
        
        .list-item-hover:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* Performance indicators */
        .performance-indicator {
            transition: all 0.3s ease;
        }
        
        .performance-indicator:hover {
            transform: scale(1.05);
        }
        
        /* Sparkline animation */
        .sparkline-line {
            animation: drawLine 0.8s ease-out;
        }
        
        @keyframes drawLine {
            from {
                stroke-dasharray: 1000;
                stroke-dashoffset: 1000;
            }
            to {
                stroke-dashoffset: 0;
            }
        }
        
        /* Ticker badge styles */
        .ticker-badge {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="min-h-screen flex bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 text-gray-900">
    <div id="root" class="flex w-screen h-screen"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Universal Navigation Bar Component
        const UniversalNavbar = ({ 
            currentPage = 'chatbot', // 'chatbot', 'news', 'watchlist'
            theme = 'light',
            currentUser = null,
            showUserMenu = false,
            setShowUserMenu = () => {},
            handleLogout = () => {},
            title = null // Optional custom title, defaults to page-specific titles
        }) => {
            const getPageTitle = () => {
                if (title) return title;
                switch (currentPage) {
                    case 'chatbot': return 'Stock Analysis Chatbot';
                    case 'news': return 'Malaysia News';
                    case 'watchlist': return 'My Watchlist';
                    default: return 'Stock Analysis Platform';
                }
            };

            const getNavigationLinks = () => {
                const links = [
                    { 
                        key: 'chatbot', 
                        href: '/', 
                        label: 'Chatbot', 
                        color: 'blue',
                        active: currentPage === 'chatbot'
                    },
                    { 
                        key: 'news', 
                        href: '/news.html', 
                        label: 'News', 
                        color: 'green',
                        active: currentPage === 'news'
                    },
                    { 
                        key: 'watchlist', 
                        href: '/watchlist.html', 
                        label: 'Watchlist', 
                        color: 'purple',
                        active: currentPage === 'watchlist'
                    }
                ];
                
                // Filter out current page from navigation links
                return links.filter(link => !link.active);
            };

            const getButtonClasses = (color, isActive = false) => {
                const baseClasses = "px-3 py-1.5 rounded-lg font-medium transition-colors text-xs";
                
                if (isActive) {
                    return `${baseClasses} ${
                        theme === 'dark' 
                            ? 'bg-gray-700 text-white' 
                            : 'bg-gray-200 text-gray-900'
                    }`;
                }

                const colorClasses = {
                    blue: theme === 'dark' 
                        ? 'bg-blue-600 text-white hover:bg-blue-700' 
                        : 'bg-blue-500 text-white hover:bg-blue-600',
                    green: theme === 'dark' 
                        ? 'bg-green-600 text-white hover:bg-green-700' 
                        : 'bg-green-500 text-white hover:bg-green-600',
                    purple: theme === 'dark' 
                        ? 'bg-purple-600 text-white hover:bg-purple-700' 
                        : 'bg-purple-500 text-white hover:bg-purple-600'
                };

                return `${baseClasses} ${colorClasses[color]}`;
            };

            return React.createElement('div', {
                className: `p-2 border-b theme-transition z-30 ${
                    theme === 'dark' 
                        ? 'liquid-glass-dark border-gray-600' 
                        : 'liquid-glass border-gray-200'
                }`
            }, 
                React.createElement('div', {
                    className: 'max-w-7xl mx-auto'
                },
                    React.createElement('div', {
                        className: 'flex items-center justify-between'
                    },
                        // Left side - Title only
                        React.createElement('div', {
                            className: 'flex items-center space-x-4'
                        },
                            // Page title
                            React.createElement('h1', {
                                className: `text-lg font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`
                            }, getPageTitle())
                        ),

                        // Right side - Navigation Links and User Profile
                        React.createElement('div', {
                            className: 'flex items-center space-x-3'
                        },
                            // Navigation Links - moved to right side near profile
                            React.createElement('div', {
                                className: 'flex items-center space-x-2'
                            },
                                ...getNavigationLinks().map(link => 
                                    React.createElement('a', {
                                        key: link.key,
                                        href: link.href,
                                        className: getButtonClasses(link.color)
                                    }, link.label)
                                )
                            ),

                            // User Profile
                            currentUser && React.createElement('div', {
                                className: 'relative'
                            },
                                React.createElement('button', {
                                    onClick: () => setShowUserMenu(!showUserMenu),
                                    className: `flex items-center space-x-2 p-1.5 rounded-lg transition-colors ${
                                        theme === 'dark' 
                                            ? 'bg-gray-700 hover:bg-gray-600 text-white' 
                                            : 'bg-gray-100 hover:bg-gray-200 text-gray-900'
                                    }`
                                },
                                    React.createElement('div', {
                                        className: 'w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white font-medium text-xs'
                                    }, currentUser.first_name ? currentUser.first_name[0].toUpperCase() : currentUser.email[0].toUpperCase()),
                                    React.createElement('span', {
                                        className: 'text-sm font-medium'
                                    }, currentUser.first_name || 'User'),
                                    React.createElement('svg', {
                                        className: 'w-3 h-3',
                                        fill: 'none',
                                        stroke: 'currentColor',
                                        viewBox: '0 0 24 24'
                                    },
                                        React.createElement('path', {
                                            strokeLinecap: 'round',
                                            strokeLinejoin: 'round',
                                            strokeWidth: '2',
                                            d: 'M19 9l-7 7-7-7'
                                        })
                                    )
                                ),

                            // User dropdown menu
                            showUserMenu && React.createElement('div', {
                                className: `absolute right-0 mt-2 w-48 ${
                                    theme === 'dark' 
                                        ? 'bg-gray-800 border-gray-700' 
                                        : 'bg-white border-gray-200'
                                } rounded-lg shadow-lg border z-50`
                            },
                                React.createElement('div', {
                                    className: 'py-1'
                                },
                                    // User info
                                    React.createElement('div', {
                                        className: `px-4 py-2 border-b ${
                                            theme === 'dark' ? 'border-gray-700' : 'border-gray-200'
                                        }`
                                    },
                                        React.createElement('p', {
                                            className: `text-sm font-medium ${
                                                theme === 'dark' ? 'text-white' : 'text-gray-900'
                                            }`
                                        }, currentUser.full_name || currentUser.email),
                                        React.createElement('p', {
                                            className: `text-xs ${
                                                theme === 'dark' ? 'text-gray-400' : 'text-gray-500'
                                            }`
                                        }, currentUser.email)
                                    ),
                                    // Profile link
                                    React.createElement('a', {
                                        href: '/auth/profile',
                                        className: `block px-4 py-2 text-sm transition-colors ${
                                            theme === 'dark' 
                                                ? 'text-gray-300 hover:bg-gray-700 hover:text-white' 
                                                : 'text-gray-700 hover:bg-gray-100'
                                        }`
                                    }, 'Profile'),
                                    // Logout button
                                    React.createElement('button', {
                                        onClick: handleLogout,
                                        className: `block w-full text-left px-4 py-2 text-sm transition-colors ${
                                            theme === 'dark' 
                                                ? 'text-red-400 hover:bg-gray-700 hover:text-red-300' 
                                                : 'text-red-600 hover:bg-gray-100'
                                        }`
                                    }, 'Logout')
                                )
                            )
                        )
                    )
                )
                        )            );
        };

        // Configuration - Change this port when needed
        const API_BASE_URL = 'http://localhost:5000'; // Change this port as needed
        
        function WatchlistApp() {
            const [theme, setTheme] = useState('light');
            const [watchlist, setWatchlist] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [searchModalOpen, setSearchModalOpen] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [isSearching, setIsSearching] = useState(false);
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [suggestions, setSuggestions] = useState([]);
            const [selectedSuggestionIndex, setSelectedSuggestionIndex] = useState(-1);
            const [selectedStock, setSelectedStock] = useState(null);
            const [stockDetails, setStockDetails] = useState(null);
            const [loadingStockDetails, setLoadingStockDetails] = useState(false);
            const [availableSectors, setAvailableSectors] = useState([]);
            const [availableIndustries, setAvailableIndustries] = useState([]);
            const [selectedSector, setSelectedSector] = useState('all');
            const [selectedIndustry, setSelectedIndustry] = useState('all');
            const [currentUser, setCurrentUser] = useState(null);
            const [showUserMenu, setShowUserMenu] = useState(false);
            const [viewMode, setViewMode] = useState('cards'); // 'cards' or 'list'
            const [sortBy, setSortBy] = useState('name'); // 'name', 'price', 'change', 'market_cap'
            const [sortOrder, setSortOrder] = useState('asc'); // 'asc' or 'desc'
            const [confirmModalOpen, setConfirmModalOpen] = useState(false);
            const [stockToRemove, setStockToRemove] = useState(null);

            const searchInputRef = useRef(null);

            // Check authentication status
            const checkAuth = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/auth/check`, {
                        credentials: 'include'
                    });
                    const data = await response.json();
                    if (data.authenticated) {
                        setCurrentUser(data.user);
                    } else {
                        // Redirect to test auth page for debugging
                        window.location.href = '/test-auth.html';
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                    window.location.href = '/test-auth.html';
                }
            };

            // Logout function
            const handleLogout = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/auth/logout`, { 
                        method: 'POST',
                        credentials: 'include'
                    });
                    if (response.ok) {
                        window.location.href = '/auth/login';
                    }
                } catch (error) {
                    console.error('Logout failed:', error);
                }
            };

            const loadWatchlist = async () => {
                try {
                    setLoading(true);
                    const response = await fetch(`${API_BASE_URL}/watchlist/list`, {
                        credentials: 'include'
                    });
                    const data = await response.json();

                    if (response.ok) {
                        setWatchlist(data.watchlist || []);
                        setAvailableSectors(data.available_sectors || []);
                        setAvailableIndustries(data.available_industries || []);
                    } else {
                        setError(data.error || 'Failed to load watchlist');
                    }
                } catch (err) {
                    setError('Failed to connect to server');
                } finally {
                    setLoading(false);
                }
            };

            // Debounced search function
            const debouncedSearch = useRef(null);
            
            const handleSearchInput = async (query) => {
                setSearchQuery(query);
                
                // Clear previous debounce
                if (debouncedSearch.current) {
                    clearTimeout(debouncedSearch.current);
                }
                
                if (!query.trim()) {
                    setSuggestions([]);
                    setShowSuggestions(false);
                    return;
                }
                
                // Debounce the search to avoid too many API calls
                debouncedSearch.current = setTimeout(async () => {
                    try {
                        setIsSearching(true);
                        const response = await fetch(`${API_BASE_URL}/watchlist/search/local?q=${encodeURIComponent(query)}&limit=8`);
                        const data = await response.json();

                        if (response.ok) {
                            setSuggestions(data.results || []);
                            setShowSuggestions(true);
                            setSelectedSuggestionIndex(-1);
                        } else {
                            setSuggestions([]);
                            setShowSuggestions(false);
                        }
                    } catch (err) {
                        setSuggestions([]);
                        setShowSuggestions(false);
                    } finally {
                        setIsSearching(false);
                    }
                }, 300); // 300ms delay
            };

            const handleSuggestionClick = async (suggestion) => {
                setSelectedStock(suggestion);
                setSearchQuery(suggestion.company_name);
                setShowSuggestions(false);
                setSuggestions([]);
                
                // Fetch detailed stock data
                await fetchStockDetails(suggestion.ticker);
            };

            const fetchStockDetails = async (ticker) => {
                try {
                    setLoadingStockDetails(true);
                    const response = await fetch(`${API_BASE_URL}/watchlist/stock/details?ticker=${ticker}`);
                    const data = await response.json();

                    if (response.ok) {
                        setStockDetails(data.stock_details);
                    } else {
                        setError(data.error || 'Failed to fetch stock details');
                    }
                } catch (err) {
                    setError('Failed to fetch stock details');
                } finally {
                    setLoadingStockDetails(false);
                }
            };

            const handleKeyDown = (e) => {
                if (!showSuggestions || suggestions.length === 0) return;

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        setSelectedSuggestionIndex(prev => 
                            prev < suggestions.length - 1 ? prev + 1 : prev
                        );
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        setSelectedSuggestionIndex(prev => prev > 0 ? prev - 1 : -1);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (selectedSuggestionIndex >= 0) {
                            handleSuggestionClick(suggestions[selectedSuggestionIndex]);
                        }
                        break;
                    case 'Escape':
                        setShowSuggestions(false);
                        setSuggestions([]);
                        setSelectedSuggestionIndex(-1);
                        break;
                }
            };

            const addToWatchlist = async (stock) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/watchlist/add`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            ticker: stock.ticker,
                            company_name: stock.company_name
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Add to local watchlist with fetched details
                        const newStock = {
                            id: Date.now().toString(),
                            ticker: stock.ticker,
                            company_name: stock.company_name,
                            current_price: stockDetails?.current_price || 'N/A',
                            market_cap: stockDetails?.market_cap || 'N/A',
                            pe_ratio: stockDetails?.pe_ratio || 'N/A',
                            volume: stockDetails?.volume || 'N/A',
                            price_change: stockDetails?.price_change || 0,
                            price_change_percent: stockDetails?.price_change_percent || 0,
                            added_at: new Date().toISOString(),
                            last_updated: new Date().toISOString()
                        };
                        
                        setWatchlist(prev => [...prev, newStock]);
                        setSearchModalOpen(false);
                        setSearchQuery('');
                        setSearchResults([]);
                        setSelectedStock(null);
                        setStockDetails(null);
                    } else {
                        setError(data.error || 'Failed to add stock');
                    }
                } catch (err) {
                    setError('Failed to add stock to watchlist');
                }
            };

            const showRemoveConfirmation = (stock) => {
                setStockToRemove(stock);
                setConfirmModalOpen(true);
            };

            const confirmRemoveFromWatchlist = async () => {
                if (!stockToRemove) return;
                
                try {
                    const response = await fetch(`${API_BASE_URL}/watchlist/remove`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            ticker: stockToRemove.ticker
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        setWatchlist(prev => prev.filter(stock => stock.ticker !== stockToRemove.ticker));
                        setConfirmModalOpen(false);
                        setStockToRemove(null);
                    } else {
                        setError(data.error || 'Failed to remove stock');
                    }
                } catch (err) {
                    setError('Failed to remove stock from watchlist');
                }
            };

            const cancelRemove = () => {
                setConfirmModalOpen(false);
                setStockToRemove(null);
            };

            useEffect(() => {
                checkAuth();
            }, []);

            useEffect(() => {
                if (currentUser) {
                    loadWatchlist();
                }
            }, [currentUser]);

            // Close suggestions when clicking outside
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (searchInputRef.current && !searchInputRef.current.contains(event.target)) {
                        setShowSuggestions(false);
                    }
                };

                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const formatPrice = (price) => {
                if (price === 'N/A' || price === null || price === undefined) return 'N/A';
                return `RM ${parseFloat(price).toFixed(2)}`;
            };

            const formatMarketCap = (marketCap) => {
                if (marketCap === 'N/A' || marketCap === null || marketCap === undefined) return 'N/A';
                const value = parseFloat(marketCap);
                if (value >= 1e9) return `RM ${(value / 1e9).toFixed(2)}B`;
                if (value >= 1e6) return `RM ${(value / 1e6).toFixed(2)}M`;
                return `RM ${value.toFixed(2)}`;
            };

            const formatVolume = (volume) => {
                if (volume === 'N/A' || volume === null || volume === undefined) return 'N/A';
                const value = parseFloat(volume);
                if (value >= 1e6) return `${(value / 1e6).toFixed(1)}M`;
                if (value >= 1e3) return `${(value / 1e3).toFixed(1)}K`;
                return value.toLocaleString();
            };

            // Filter watchlist based on selected sector and industry
            const filteredWatchlist = watchlist.filter(stock => {
                const sectorMatch = selectedSector === 'all' || stock.sector === selectedSector;
                const industryMatch = selectedIndustry === 'all' || stock.industry === selectedIndustry;
                return sectorMatch && industryMatch;
            });

            // Sort the filtered watchlist
            const sortedWatchlist = [...filteredWatchlist].sort((a, b) => {
                let aValue, bValue;
                
                switch (sortBy) {
                    case 'name':
                        aValue = a.company_name.toLowerCase();
                        bValue = b.company_name.toLowerCase();
                        break;
                    case 'price':
                        aValue = parseFloat(a.current_price) || 0;
                        bValue = parseFloat(b.current_price) || 0;
                        break;
                    case 'change':
                        aValue = a.price_change_percent || 0;
                        bValue = b.price_change_percent || 0;
                        break;
                    case 'market_cap':
                        aValue = parseFloat(a.market_cap) || 0;
                        bValue = parseFloat(b.market_cap) || 0;
                        break;
                    default:
                        aValue = a.company_name.toLowerCase();
                        bValue = b.company_name.toLowerCase();
                }
                
                if (sortOrder === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });

            return (
                <div className="flex w-full h-screen">
                    <div className="flex-1 flex flex-col">
                        {/* Header */}
                        <UniversalNavbar 
                            currentPage="watchlist"
                            theme="light"
                            currentUser={currentUser}
                            showUserMenu={showUserMenu}
                            setShowUserMenu={setShowUserMenu}
                            handleLogout={handleLogout}
                            title={
                                sortedWatchlist.length !== watchlist.length 
                                    ? `My Watchlist (${sortedWatchlist.length} of ${watchlist.length} shown)`
                                    : "My Watchlist"
                            }
                        />

                        {/* Filter Controls */}
                        <div className="p-4 border-b liquid-glass border-gray-200">
                            {watchlist.length > 0 && (
                                <div className="max-w-7xl mx-auto">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center space-x-4">
                                            <div className="flex items-center space-x-2">
                                                <label className="text-sm font-medium text-gray-700">Filter by Sector:</label>
                                                <select
                                                    value={selectedSector}
                                                    onChange={(e) => setSelectedSector(e.target.value)}
                                                    className="px-3 py-1 rounded-lg border bg-white text-gray-900 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                                >
                                                    <option value="all">All Sectors</option>
                                                    {availableSectors.map(sector => (
                                                        <option key={sector} value={sector}>{sector}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            
                                            <div className="flex items-center space-x-2">
                                                <label className="text-sm font-medium text-gray-700">Filter by Industry:</label>
                                                <select
                                                    value={selectedIndustry}
                                                    onChange={(e) => setSelectedIndustry(e.target.value)}
                                                    className="px-3 py-1 rounded-lg border bg-white text-gray-900 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                                >
                                                    <option value="all">All Industries</option>
                                                    {availableIndustries.map(industry => (
                                                        <option key={industry} value={industry}>{industry}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            {(selectedSector !== 'all' || selectedIndustry !== 'all') && (
                                                <button
                                                    onClick={() => {
                                                        setSelectedSector('all');
                                                        setSelectedIndustry('all');
                                                    }}
                                                    className="px-3 py-1 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm transition-colors"
                                                >
                                                    Clear Filters
                                                </button>
                                            )}
                                            
                                            {/* View Mode Toggle - moved closer to filters */}
                                            <div className="flex items-center space-x-2 ml-4">
                                                <span className="text-sm font-medium text-gray-700">View:</span>
                                                <div className="flex bg-gray-200 rounded-lg p-1">
                                                    <button
                                                        onClick={() => setViewMode('cards')}
                                                        className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
                                                            viewMode === 'cards'
                                                                ? 'bg-white text-blue-600 shadow-sm'
                                                                : 'text-gray-600 hover:text-gray-800'
                                                        }`}
                                                        title="Card View"
                                                    >
                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                                                        </svg>
                                                    </button>
                                                    <button
                                                        onClick={() => setViewMode('list')}
                                                        className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
                                                            viewMode === 'list'
                                                                ? 'bg-white text-blue-600 shadow-sm'
                                                                : 'text-gray-600 hover:text-gray-800'
                                                        }`}
                                                        title="List View"
                                                    >
                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Add Stock Button - rightmost side */}
                                        <button
                                            onClick={() => setSearchModalOpen(true)}
                                            className="px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 font-medium transition-all duration-200 hover:scale-105 text-sm"
                                        >
                                            <div className="flex items-center space-x-1">
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                                </svg>
                                                <span>Add Stock</span>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Main Content */}
                        <div className="flex-1 p-6 overflow-y-auto">
                            <div className="max-w-7xl mx-auto">
                                {/* Error Message */}
                                {error && (
                                    <div className="mb-6 p-4 rounded-lg bg-red-100 border border-red-400 text-red-700 flex items-start justify-between">
                                        <span className="pr-4 text-sm">{error}</span>
                                        <button
                                            aria-label="Close alert"
                                            className="ml-4 text-red-700 hover:text-red-900"
                                            onClick={() => setError('')}
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                )}

                                {/* Loading State */}
                                {loading && (
                                    <div className="text-center py-12">
                                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                                        <p className="text-lg">Loading your watchlist...</p>
                                    </div>
                                )}

                                {/* Empty State */}
                                {!loading && sortedWatchlist.length === 0 && watchlist.length === 0 && (
                                    <div className="text-center py-12">
                                        <div className="w-24 h-24 mx-auto mb-4 rounded-full bg-gray-200 flex items-center justify-center">
                                            <svg className="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                            </svg>
                                        </div>
                                        <h3 className="text-xl font-semibold mb-2">Your watchlist is empty</h3>
                                        <p className="text-gray-600 mb-6">
                                            Start by adding some Bursa Malaysia stocks to track their performance.
                                        </p>
                                        <button
                                            onClick={() => setSearchModalOpen(true)}
                                            className="px-6 py-3 rounded-lg bg-blue-500 text-white hover:bg-blue-600 font-medium"
                                        >
                                            Add Your First Stock
                                        </button>
                                    </div>
                                )}

                                {/* No Results After Filtering */}
                                {!loading && sortedWatchlist.length === 0 && watchlist.length > 0 && (
                                    <div className="text-center py-12">
                                        <div className="w-24 h-24 mx-auto mb-4 rounded-full bg-yellow-100 flex items-center justify-center">
                                            <svg className="w-12 h-12 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                                            </svg>
                                        </div>
                                        <h3 className="text-xl font-semibold mb-2">No stocks match your filters</h3>
                                        <p className="text-gray-600 mb-6">
                                            Try selecting different sector or industry filters, or clear all filters to see your full watchlist.
                                        </p>
                                        <button
                                            onClick={() => {
                                                setSelectedSector('all');
                                                setSelectedIndustry('all');
                                            }}
                                            className="px-6 py-3 rounded-lg bg-blue-500 text-white hover:bg-blue-600 font-medium"
                                        >
                                            Clear All Filters
                                        </button>
                                    </div>
                                )}

                                {/* Performance Summary */}
                                {!loading && sortedWatchlist.length > 0 && (
                                    <div className="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            <div className="text-center performance-indicator">
                                                <div className="text-2xl font-bold text-blue-600">{sortedWatchlist.length}</div>
                                                <div className="text-sm text-gray-600">Total Stocks</div>
                                            </div>
                                            <div className="text-center performance-indicator">
                                                <div className={`text-2xl font-bold ${
                                                    sortedWatchlist.filter(s => s.price_change_percent > 0).length > 
                                                    sortedWatchlist.filter(s => s.price_change_percent < 0).length 
                                                        ? 'text-green-600' : 'text-red-600'
                                                }`}>
                                                    {sortedWatchlist.filter(s => s.price_change_percent > 0).length}
                                                </div>
                                                <div className="text-sm text-gray-600">Gainers</div>
                                            </div>
                                            <div className="text-center performance-indicator">
                                                <div className="text-2xl font-bold text-red-600">
                                                    {sortedWatchlist.filter(s => s.price_change_percent < 0).length}
                                                </div>
                                                <div className="text-sm text-gray-600">Decliners</div>
                                            </div>
                                            <div className="text-center performance-indicator">
                                                <div className="text-2xl font-bold text-gray-600">
                                                    {sortedWatchlist.filter(s => s.price_change_percent === 0).length}
                                                </div>
                                                <div className="text-sm text-gray-600">Unchanged</div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Sorting Controls */}
                                {!loading && sortedWatchlist.length > 0 && (
                                    <div className="mb-4 flex items-center justify-between">
                                        <div className="flex items-center space-x-4">
                                            <span className="text-sm font-medium text-gray-700">Sort by:</span>
                                            <select
                                                value={sortBy}
                                                onChange={(e) => setSortBy(e.target.value)}
                                                className="px-3 py-1.5 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            >
                                                <option value="name">Company Name</option>
                                                <option value="price">Current Price</option>
                                                <option value="change">Price Change</option>
                                                <option value="market_cap">Market Cap</option>
                                            </select>
                                            <button
                                                onClick={() => setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')}
                                                className="p-1.5 rounded-md bg-gray-100 hover:bg-gray-200 transition-colors"
                                                title={sortOrder === 'asc' ? 'Sort Descending' : 'Sort Ascending'}
                                            >
                                                {sortOrder === 'asc' ? (
                                                    <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 15l7-7 7 7" />
                                                    </svg>
                                                ) : (
                                                    <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
                                                    </svg>
                                                )}
                                            </button>
                                        </div>
                                        <div className="text-sm text-gray-500">
                                            Showing {sortedWatchlist.length} stocks
                                        </div>
                                    </div>
                                )}

                                {/* Watchlist Content - Cards or List View */}
                                {!loading && sortedWatchlist.length > 0 && (
                                    <>
                                        {viewMode === 'cards' ? (
                                            /* Card View */
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                                {sortedWatchlist.map((stock) => (
                                                    <div
                                                        key={stock.id}
                                                        className="stock-card p-6 rounded-xl liquid-glass border border-gray-200"
                                                    >
                                                        <div className="flex justify-between items-start mb-4">
                                                            <div className="flex-1">
                                                                <h3 className="font-semibold text-lg mb-1">{stock.company_name}</h3>
                                                                <p className="text-sm text-gray-500">{stock.ticker}</p>
                                                                {(stock.sector !== 'N/A' || stock.industry !== 'N/A') && (
                                                                    <div className="mt-1 flex flex-wrap gap-1">
                                                                        {stock.sector !== 'N/A' && (
                                                                            <span className="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded-full">
                                                                                {stock.sector}
                                                                            </span>
                                                                        )}
                                                                        {stock.industry !== 'N/A' && (
                                                                            <span className="px-2 py-1 text-xs bg-green-100 text-green-700 rounded-full">
                                                                                {stock.industry}
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                )}
                                                            </div>
                                                            <button
                                                                onClick={() => showRemoveConfirmation(stock)}
                                                                className="p-1 rounded-full text-gray-500 hover:text-red-500 hover:bg-gray-100 transition-colors"
                                                                title="Remove from watchlist"
                                                            >
                                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                                                </svg>
                                                            </button>
                                                        </div>

                                                        <div className="space-y-3">
                                                            <div className="flex justify-between items-center">
                                                                <span className="text-sm text-gray-500">Current Price</span>
                                                                <span className="font-semibold">{formatPrice(stock.current_price)}</span>
                                                            </div>

                                                            {stock.price_change !== 0 && (
                                                                <div className="flex justify-between items-center">
                                                                    <span className="text-sm text-gray-500">Change</span>
                                                                    <div className="flex items-center space-x-1">
                                                                        <span className={`font-medium ${stock.price_change_percent > 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                                            {stock.price_change_percent > 0 ? '↗' : '↘'} {formatPrice(Math.abs(stock.price_change))}
                                                                        </span>
                                                                        <span className={`text-sm ${stock.price_change_percent > 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                                            ({stock.price_change_percent > 0 ? '+' : ''}{stock.price_change_percent}%)
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            )}

                                                            <div className="flex justify-between items-center">
                                                                <span className="text-sm text-gray-500">Market Cap</span>
                                                                <span className="text-sm">{formatMarketCap(stock.market_cap)}</span>
                                                            </div>

                                                            <div className="flex justify-between items-center">
                                                                <span className="text-sm text-gray-500">P/E Ratio</span>
                                                                <span className="text-sm">{stock.pe_ratio === 'N/A' ? 'N/A' : stock.pe_ratio}</span>
                                                            </div>

                                                            <div className="flex justify-between items-center">
                                                                <span className="text-sm text-gray-500">Volume</span>
                                                                <span className="text-sm">{formatVolume(stock.volume)}</span>
                                                            </div>
                                                        </div>

                                                        <div className="mt-4 pt-3 border-t border-gray-200">
                                                            <div className="flex justify-between items-center text-xs text-gray-500">
                                                                <span>Added: {new Date(stock.added_at).toLocaleDateString()}</span>
                                                                <span>Updated: {new Date(stock.last_updated).toLocaleTimeString()}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            /* List View */
                                            <div className="space-y-3">
                                                {sortedWatchlist.map((stock) => (
                                                    <div
                                                        key={stock.id}
                                                        className="flex items-center justify-between p-4 rounded-lg liquid-glass border border-gray-200 hover:bg-gray-50 transition-colors list-item-hover"
                                                    >
                                                        {/* Left side - Ticker and Company Name */}
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex items-center space-x-3">
                                                                <div className="flex-shrink-0">
                                                                    <div className="w-12 h-8 ticker-badge rounded flex items-center justify-center shadow-sm">
                                                                        <span className="text-xs font-bold">
                                                                            {stock.ticker.replace('.KL', '')}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                                <div className="min-w-0 flex-1">
                                                                    <h3 className="font-semibold text-gray-900 truncate">
                                                                        {stock.company_name}
                                                                    </h3>
                                                                    <p className="text-sm text-gray-500 truncate">
                                                                        {stock.ticker}
                                                                    </p>
                                                                    {(stock.sector !== 'N/A' || stock.industry !== 'N/A') && (
                                                                        <div className="mt-1 flex flex-wrap gap-1">
                                                                            {stock.sector !== 'N/A' && (
                                                                                <span className="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded-full">
                                                                                    {stock.sector}
                                                                                </span>
                                                                            )}
                                                                            {stock.industry !== 'N/A' && (
                                                                                <span className="px-2 py-1 text-xs bg-green-100 text-green-700 rounded-full">
                                                                                    {stock.industry}
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        </div>

                                                                                                                {/* Center - Mini Sparkline Chart */}
                                                        <div className="flex-shrink-0 mx-4">
                                                            <div className="w-20 h-8 flex items-center justify-center">
                                                                {/* Enhanced sparkline representation */}
                                                                <svg className="w-20 h-8" viewBox="0 0 80 32">
                                                                    {/* Generate a simple line chart based on price change */}
                                                                    <path
                                                                        className={`sparkline-line ${
                                                                            stock.price_change_percent > 0 
                                                                                ? 'sparkline-positive' 
                                                                                : stock.price_change_percent < 0 
                                                                                ? 'sparkline-negative' 
                                                                                : 'sparkline-neutral'
                                                                        }`}
                                                                        d={(() => {
                                                                            // Create a more realistic line chart with variation
                                                                            const points = [];
                                                                            const width = 80;
                                                                            const height = 32;
                                                                            const segments = 8;
                                                                            
                                                                            for (let i = 0; i <= segments; i++) {
                                                                                const x = (i / segments) * width;
                                                                                let y;
                                                                                
                                                                                if (stock.price_change_percent > 0) {
                                                                                    // Upward trend with variation
                                                                                    const baseY = height - (i / segments) * height * 0.6 - height * 0.2;
                                                                                    const variation = (Math.random() - 0.5) * height * 0.1;
                                                                                    y = baseY + variation;
                                                                                } else if (stock.price_change_percent < 0) {
                                                                                    // Downward trend with variation
                                                                                    const baseY = (i / segments) * height * 0.6 + height * 0.2;
                                                                                    const variation = (Math.random() - 0.5) * height * 0.1;
                                                                                    y = baseY + variation;
                                                                                } else {
                                                                                    // Flat line with slight variation
                                                                                    const baseY = height / 2;
                                                                                    const variation = (Math.random() - 0.5) * height * 0.05;
                                                                                    y = baseY + variation;
                                                                                }
                                                                                
                                                                                points.push(`${x},${y}`);
                                                                            }
                                                                            
                                                                            return `M ${points.join(' L ')}`;
                                                                        })()}
                                                                    />
                                                                </svg>
                                                            </div>
                                                        </div>

                                                        {/* Right side - Price and Change */}
                                                        <div className="flex items-center space-x-4">
                                                            <div className="text-right">
                                                                <div className="font-semibold text-gray-900">
                                                                    {formatPrice(stock.current_price)}
                                                                </div>
                                                                <div className="text-xs text-gray-500">
                                                                    {stock.volume !== 'N/A' ? formatVolume(stock.volume) : 'N/A'} vol
                                                                </div>
                                                            </div>
                                                            
                                                            <div className="text-right">
                                                                <div className={`px-2 py-1 rounded text-sm font-medium ${
                                                                    stock.price_change_percent > 0
                                                                        ? 'bg-green-100 text-green-800'
                                                                        : stock.price_change_percent < 0
                                                                        ? 'bg-red-100 text-red-800'
                                                                        : 'bg-gray-100 text-gray-800'
                                                                }`}>
                                                                    {stock.price_change_percent > 0 ? '+' : ''}{stock.price_change_percent.toFixed(2)}%
                                                                </div>
                                                                <div className={`text-xs ${
                                                                    stock.price_change_percent > 0 ? 'text-green-600' : 'text-red-600'
                                                                }`}>
                                                                    {stock.price_change_percent > 0 ? '↗' : stock.price_change_percent < 0 ? '↘' : '→'} {formatPrice(Math.abs(stock.price_change))}
                                                                </div>
                                                            </div>

                                                            {/* Remove button */}
                                                            <button
                                                                onClick={() => showRemoveConfirmation(stock)}
                                                                className="p-2 rounded-full text-gray-400 hover:text-red-500 hover:bg-red-50 transition-colors"
                                                                title="Remove from watchlist"
                                                            >
                                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Enhanced Search Modal */}
                    {searchModalOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="max-w-2xl w-full mx-4 p-6 rounded-2xl liquid-glass text-gray-900">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-semibold">Stock Search</h3>
                                    <button
                                        onClick={() => {
                                            setSearchModalOpen(false);
                                            setSearchQuery('');
                                            setSuggestions([]);
                                            setSelectedStock(null);
                                            setStockDetails(null);
                                        }}
                                        className="text-gray-400 hover:text-gray-600"
                                    >
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>

                                <div className="mb-4">
                                    <div className="search-input-container" ref={searchInputRef}>
                                        <input
                                            type="text"
                                            value={searchQuery}
                                            onChange={(e) => handleSearchInput(e.target.value)}
                                            onKeyDown={handleKeyDown}
                                            placeholder="Search by company name or stock code (e.g., Maybank, 1155)"
                                            className="w-full p-3 rounded-lg border bg-white text-gray-900 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        />
                                        
                                        {/* Auto-suggestions */}
                                        {showSuggestions && (
                                            <div className="suggestions-container">
                                                {isSearching ? (
                                                    <div className="p-4 text-center text-gray-500">
                                                        <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500 mx-auto mb-2"></div>
                                                        Searching...
                                                    </div>
                                                ) : suggestions.length > 0 ? (
                                                    suggestions.map((suggestion, index) => (
                                                        <div
                                                            key={index}
                                                            className={`suggestion-item ${
                                                                index === selectedSuggestionIndex ? 'selected' : ''
                                                            }`}
                                                            onClick={() => handleSuggestionClick(suggestion)}
                                                        >
                                                            <div className="flex justify-between items-center">
                                                                <div>
                                                                    <div className="font-medium">{suggestion.company_name}</div>
                                                                    <div className="text-sm text-gray-500">
                                                                        {suggestion.stock_code} • {suggestion.ticker}
                                                                    </div>
                                                                </div>
                                                                {/* <div className="text-xs text-gray-400">
                                                                    Score: {suggestion.search_score}
                                                                </div> */}
                                                            </div>
                                                        </div>
                                                    ))
                                                ) : (
                                                    <div className="p-4 text-center text-gray-500">
                                                        No matches found
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Selected Stock Details */}
                                {selectedStock && (
                                    <div className="mb-4 p-4 rounded-lg border bg-gray-50 border-gray-200">
                                        <h4 className="font-medium mb-2">Selected Stock</h4>
                                        <div className="flex justify-between items-center">
                                            <div>
                                                <div className="font-medium">{selectedStock.company_name}</div>
                                                <div className="text-sm text-gray-500">
                                                    {selectedStock.stock_code} • {selectedStock.ticker}
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => {
                                                    setSelectedStock(null);
                                                    setStockDetails(null);
                                                    setSearchQuery('');
                                                }}
                                                className="text-gray-400 hover:text-gray-600"
                                            >
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {/* Stock Financial Details */}
                                {stockDetails && (
                                    <div className="mb-4 p-4 rounded-lg border bg-blue-50 border-blue-200">
                                        <h4 className="font-medium mb-3">Financial Data</h4>
                                        <div className="grid grid-cols-2 gap-4 text-sm">
                                            <div>
                                                <span className="text-gray-500">Current Price:</span>
                                                <span className="ml-2 font-medium">{formatPrice(stockDetails.current_price)}</span>
                                            </div>
                                            <div>
                                                <span className="text-gray-500">Market Cap:</span>
                                                <span className="ml-2 font-medium">{formatMarketCap(stockDetails.market_cap)}</span>
                                            </div>
                                            <div>
                                                <span className="text-gray-500">P/E Ratio:</span>
                                                <span className="ml-2 font-medium">{stockDetails.pe_ratio}</span>
                                            </div>
                                            <div>
                                                <span className="text-gray-500">Volume:</span>
                                                <span className="ml-2 font-medium">{formatVolume(stockDetails.volume)}</span>
                                            </div>
                                            <div>
                                                <span className="text-gray-500">52W High:</span>
                                                <span className="ml-2 font-medium">{formatPrice(stockDetails.fifty_two_week_high)}</span>
                                            </div>
                                            <div>
                                                <span className="text-gray-500">52W Low:</span>
                                                <span className="ml-2 font-medium">{formatPrice(stockDetails.fifty_two_week_low)}</span>
                                            </div>
                                        </div>
                                        
                                        {/* Data Quality Indicator */}
                                        <div className="mt-3 pt-3 border-t border-blue-200">
                                            <div className="flex items-center justify-between text-xs">
                                                <span className="text-gray-500">Data Quality:</span>
                                                <div className="flex space-x-1">
                                                    {Object.entries(stockDetails.data_quality).map(([key, available]) => (
                                                        <div
                                                            key={key}
                                                            className={`w-2 h-2 rounded-full ${
                                                                available ? 'bg-green-500' : 'bg-gray-300'
                                                            }`}
                                                            title={`${key}: ${available ? 'Available' : 'N/A'}`}
                                                        />
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Add to Watchlist Button */}
                                {selectedStock && (
                                    <div className="flex justify-end">
                                        <button
                                            onClick={() => addToWatchlist(selectedStock)}
                                            disabled={loadingStockDetails}
                                            className={`px-6 py-3 rounded-lg font-medium transition-colors ${
                                                loadingStockDetails
                                                    ? 'bg-gray-400 cursor-not-allowed'
                                                    : 'bg-green-500 text-white hover:bg-green-600'
                                            }`}
                                        >
                                            {loadingStockDetails ? (
                                                <div className="flex items-center space-x-2">
                                                    <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                                    <span>Loading...</span>
                                                </div>
                                            ) : (
                                                <div className="flex items-center space-x-2">
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                                    </svg>
                                                    <span>Add to Watchlist</span>
                                                </div>
                                            )}
                                        </button>
                                    </div>
                                )}

                                {/* Instructions */}
                                <div className="mt-4 p-3 rounded-lg bg-gray-50 border border-gray-200">
                                    <h5 className="text-sm font-medium mb-2">Search Features:</h5>
                                    <ul className="text-xs text-gray-600 space-y-1">
                                        <li>• Instant search with auto-suggestions</li>
                                        <li>• Search by company name or stock code</li>
                                        <li>• Real-time financial data on selection</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Confirmation Modal */}
                    {confirmModalOpen && stockToRemove && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="max-w-md w-full mx-4 p-6 rounded-2xl liquid-glass text-gray-900">
                                <div className="flex items-center mb-4">
                                    <div className="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mr-4">
                                        <svg className="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-900">Remove Stock</h3>
                                        <p className="text-sm text-gray-500">This action cannot be undone</p>
                                    </div>
                                </div>

                                <div className="mb-6">
                                    <p className="text-gray-700 mb-2">
                                        Are you sure you want to remove <span className="font-semibold">{stockToRemove.company_name}</span> from your watchlist?
                                    </p>
                                    <div className="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                        <div className="flex items-center space-x-3">
                                            <div className="w-8 h-6 ticker-badge rounded flex items-center justify-center">
                                                <span className="text-xs font-bold text-white">
                                                    {stockToRemove.ticker.replace('.KL', '')}
                                                </span>
                                            </div>
                                            <div>
                                                <div className="font-medium text-gray-900">{stockToRemove.company_name}</div>
                                                <div className="text-sm text-gray-500">{stockToRemove.ticker}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex space-x-3">
                                    <button
                                        onClick={cancelRemove}
                                        className="flex-1 px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors font-medium"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={confirmRemoveFromWatchlist}
                                        className="flex-1 px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition-colors font-medium"
                                    >
                                        Remove Stock
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // React 18 compatible rendering
        const container = document.getElementById('root');
        if (typeof ReactDOM.createRoot === 'function') {
            // React 18+ way
            const root = ReactDOM.createRoot(container);
            root.render(<WatchlistApp />);
        } else {
            // Fallback for older React versions
            ReactDOM.render(<WatchlistApp />, container);
        }
    </script>
</body>
</html> 